package net.earthcomputer.clientcommands.script;

import net.minecraft.block.Block;
import net.minecraft.block.BlockState;
import net.minecraft.block.entity.BlockEntity;
import net.minecraft.client.world.ClientWorld;
import net.minecraft.nbt.CompoundTag;
import net.minecraft.state.property.Property;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.registry.Registry;

import java.lang.ref.WeakReference;

public class ScriptWorld {

    private final WeakReference<ClientWorld> world;

    public ScriptWorld(ClientWorld world) {
        this.world = new WeakReference<>(world);
    }

    private ClientWorld getWorld() {
        ClientWorld world = this.world.get();
        assert world != null;
        return world;
    }

    public String getBlock(int x, int y, int z) {
        Block block = getWorld().getBlockState(new BlockPos(x, y, z)).getBlock();
        return ScriptUtil.simplifyIdentifier(Registry.BLOCK.getId(block));
    }

    public Object getBlockProperty(int x, int y, int z, String property) {
        BlockState state = getWorld().getBlockState(new BlockPos(x, y, z));
        for (Property<?> propertyObj : state.getProperties()) {
            if (propertyObj.getName().equals(property)) {
                Object val = state.get(propertyObj);
                if (val instanceof Number)
                    return val;
                else
                    return propertyGetName(propertyObj, val);
            }
        }
        return null;
    }

    public Object getBlockEntityNbt(int x, int y, int z) {
        BlockEntity be = getWorld().getBlockEntity(new BlockPos(x, y, z));
        if (be == null)
            return null;
        return ScriptUtil.fromNbt(be.toTag(new CompoundTag()));
    }

    @SuppressWarnings("unchecked")
    private static <T extends Comparable<T>> String propertyGetName(Property<T> prop, Object val) {
        return prop.getName((T) val);
    }
}
